<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AgrarPlan Pro â€“ Sync â€¢ Karte â€¢ Kalender</title>

<!-- Leaflet + Draw -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">

<!-- FullCalendar -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">

<style>
:root{
--bg:#f4f6f5; --card:#fff; --side:#163526; --side2:#24533b; --txt:#0d1b12;
--muted:rgba(0,0,0,.65);
}
body{ margin:0; font-family:Arial,system-ui; background:var(--bg); color:var(--txt); height:100vh; display:flex; }
.sidebar{ width:250px; background:var(--side); color:#fff; padding:16px; box-sizing:border-box; }
.sidebar h1{ font-size:18px; margin:0 0 10px; }
.sidebar small{ opacity:.85; display:block; margin-bottom:10px; }
.btn{ width:100%; padding:10px 12px; border:0; border-radius:12px; background:var(--side2); color:#fff; cursor:pointer; margin-top:8px; text-align:left; }
.btn:hover{ filter:brightness(1.08); }
.content{ flex:1; padding:18px; overflow:auto; box-sizing:border-box; }
.warn{ background:#fff3cd; border:1px solid #ffe69c; padding:10px; border-radius:12px; margin-bottom:12px; }
.topbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
.topbar input{ flex:1; min-width:240px; }
section{ background:var(--card); border-radius:14px; padding:14px; box-shadow:0 2px 10px rgba(0,0,0,.05); }
section.hide{ display:none; }
h2{ margin:0 0 10px; font-size:18px; }
.row{ display:flex; gap:12px; flex-wrap:wrap; }
.card{ background:#fff; border-radius:14px; padding:14px; box-shadow:0 2px 10px rgba(0,0,0,.05); }
input, select, textarea{ width:100%; padding:10px; border-radius:12px; border:1px solid #d8e0db; box-sizing:border-box; margin:6px 0; }
textarea{ min-height:90px; resize:vertical; }
.task{ border-left:6px solid #2c7a4b; padding:10px; border-radius:12px; background:#fbfcfb; margin-top:10px; }
.task.done{ opacity:.65; text-decoration:line-through; }
.meta{ font-size:13px; color:var(--muted); margin-top:6px; }
.task button{ padding:8px 10px; border:0; border-radius:10px; cursor:pointer; margin-right:8px; }
.ok{ background:#dff3e7; }
.del{ background:#ffe2e2; }
#map{ height:540px; border-radius:14px; }
.list{ margin-top:10px; }
.list-item{ display:flex; gap:10px; align-items:center; justify-content:space-between; padding:10px; border-radius:12px; background:#f7faf8; margin-top:8px; }
.list-item .small{ font-size:12px; color:var(--muted); }
.list-item button{ padding:8px 10px; border:0; border-radius:10px; cursor:pointer; background:#ffe2e2; }
#cal{ background:#fff; border-radius:14px; padding:10px; }
</style>
</head>

<body>
<div class="sidebar">
<h1>ğŸŒ¾ AgrarPlan Pro</h1>
<small>Live-Sync â€¢ Schweiz â€¢ Satellit â€¢ FlÃ¤chen â€¢ Kalender</small>
<button class="btn" onclick="showView('dashboard')">ğŸ“Š Dashboard</button>
<button class="btn" onclick="showView('tasks')">ğŸ“‹ AuftrÃ¤ge</button>
<button class="btn" onclick="showView('calendar')">ğŸ“… Kalender</button>
<button class="btn" onclick="showView('map')">ğŸ›° Karte</button>
<button class="btn" onclick="showView('animals')">ğŸ„ Tiere</button>
<button class="btn" onclick="showView('notes')">ğŸ“ Notizen</button>
</div>

<div class="content">
<div class="warn">
<b>So funktioniert â€jeder sieht allesâ€œ:</b> Alle Ã¶ffnen denselben Link UND nutzen denselben <b>Betriebscode</b>.
Dann synchronisiert Firebase automatisch.
</div>

<div class="topbar">
<input id="farmId" placeholder="Betriebscode (z.B. HOF-MUELLER-01)" />
<button class="btn" style="width:auto" onclick="applyFarm()">âœ… Laden</button>
<button class="btn" style="width:auto" onclick="copyShareLink()">ğŸ”— Link teilen</button>
</div>

<!-- Dashboard -->
<section id="view-dashboard">
<h2>ğŸ“Š Dashboard</h2>
<div class="row">
<div class="card" style="flex:1; min-width:240px;">
<h2>AuftrÃ¤ge</h2>
<div id="statTasks">â€“</div>
</div>
<div class="card" style="flex:1; min-width:240px;">
<h2>Karte</h2>
<div id="statMap">â€“</div>
</div>
<div class="card" style="flex:1; min-width:240px;">
<h2>Tiere</h2>
<div id="statAnimals">â€“</div>
</div>
</div>
</section>

<!-- Tasks -->
<section id="view-tasks" class="hide">
<h2>ğŸ“‹ AuftrÃ¤ge</h2>
<div class="row">
<div class="card" style="flex:1; min-width:260px;">
<h2>â• Neuer Auftrag</h2>
<input id="tTitle" placeholder="Titel (z.B. Stall ausmisten)" />
<input type="date" id="tDate" />
<input id="tWorker" placeholder="Person/Team (frei eingeben)" />
<input id="tPlace" placeholder="Ort (z.B. Stall / Feld 3 / Lager)" />
<select id="tPrio">
<option value="normal">PrioritÃ¤t: Normal</option>
<option value="hoch">PrioritÃ¤t: Hoch</option>
<option value="niedrig">PrioritÃ¤t: Niedrig</option>
</select>
<textarea id="tInfo" placeholder="Weitere Informationen (Maschine, Material, Zeit, Hinweise)â€¦"></textarea>
<button class="btn" onclick="createTask()">Speichern</button>
</div>

<div class="card" style="flex:2; min-width:300px;">
<h2>ğŸ“Œ Liste</h2>
<div id="taskList"></div>
</div>
</div>
</section>

<!-- Calendar -->
<section id="view-calendar" class="hide">
<h2>ğŸ“… Kalender</h2>
<div id="cal"></div>
</section>

<!-- Map -->
<section id="view-map" class="hide">
<h2>ğŸ›° Karte Schweiz (Satellit + FlÃ¤chen)</h2>
<div class="row">
<div class="card" style="flex:2; min-width:320px;">
<div id="map"></div>
<div class="meta">
Zeichnen: Marker / FlÃ¤che (Polygon) Ã¼ber die Tools links oben auf der Karte.  
LÃ¶schen: Ã¼ber das Papierkorb-Tool ODER in der Liste rechts.
</div>
</div>
<div class="card" style="flex:1; min-width:260px;">
<h2>ğŸ§¾ Objekte</h2>
<div id="featureList" class="list"></div>
</div>
</div>
</section>

<!-- Animals -->
<section id="view-animals" class="hide">
<h2>ğŸ„ Tiere & Aufgaben</h2>
<div class="row">
<div class="card" style="flex:1; min-width:260px;">
<h2>â• Tiergruppe</h2>
<input id="aType" placeholder="Tierart (z.B. KÃ¼he, HÃ¼hner, Pferde)" />
<textarea id="aTasks" placeholder="Was muss man machen? (FÃ¼ttern, Wasser, Kontrolle, Stallâ€¦)"></textarea>
<button class="btn" onclick="addAnimal()">Speichern</button>
</div>
<div class="card" style="flex:2; min-width:300px;">
<h2>ğŸ“Œ Liste</h2>
<div id="animalList"></div>
</div>
</div>
</section>

<!-- Notes -->
<section id="view-notes" class="hide">
<h2>ğŸ“ Notizen</h2>
<textarea id="notesArea" placeholder="Allgemeine Notizen fÃ¼r den Betriebâ€¦"></textarea>
<button class="btn" onclick="saveNotes()">Speichern</button>
<div class="meta">Notizen werden live gespeichert â€“ andere sehen sie nach kurzer Zeit/Reload.</div>
</section>
</div>

<!-- Leaflet + Draw JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<!-- FullCalendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<!-- Firebase (Modular SDK) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
getFirestore, collection, doc, setDoc, addDoc, deleteDoc, updateDoc,
onSnapshot, query, orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

// âœ… HIER DEINE FIREBASE CONFIG EINFÃœGEN (aus Firebase Console â†’ Web-App)
const firebaseConfig = {
      // apiKey: "...",
      // authDomain: "...",
      // projectId: "...",
      // storageBucket: "...",
      // messagingSenderId: "...",
      // appId: "..."
    };
  apiKey: "AIzaSyA7FgCpiflkQpnYcSuTh1q2aXpTfZXQ5vo",
  authDomain: "agrarplanpro.firebaseapp.com",
  projectId: "agrarplanpro",
  storageBucket: "agrarplanpro.firebasestorage.app",
  messagingSenderId: "793787909192",
  appId: "1:793787909192:web:fac554aae83ba8431b847d" };

// ---------- Basic UI ----------
const $ = (id) => document.getElementById(id);
window.showView = (name) => {
for (const s of ["dashboard","tasks","calendar","map","animals","notes"]) {
$("view-"+s).classList.toggle("hide", s !== name);
}
if (name === "map") setTimeout(() => map.invalidateSize(), 150);
};

// ---------- Firebase init ----------
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---------- Farm Code handling ----------
let FARM = "";
function getFarmFromUrlOrStorage(){
const url = new URL(window.location.href);
const f = url.searchParams.get("farm") || localStorage.getItem("farmId") || "";
return f.trim();
}
function setFarmToUrl(farm){
const url = new URL(window.location.href);
url.searchParams.set("farm", farm);
window.history.replaceState({}, "", url.toString());
}
window.applyFarm = () => {
const f = $("farmId").value.trim();
if (!f) { alert("Bitte Betriebscode eingeben."); return; }
FARM = f;
localStorage.setItem("farmId", FARM);
setFarmToUrl(FARM);
startListeners();
alert("Betriebscode geladen: " + FARM);
};
window.copyShareLink = async () => {
if (!FARM) { alert("Erst Betriebscode laden."); return; }
const url = new URL(window.location.href);
url.searchParams.set("farm", FARM);
await navigator.clipboard.writeText(url.toString());
alert("Link kopiert! Den kannst du anderen senden.");
};

// ---------- Firestore paths ----------
const farmDoc = () => doc(db, "farms", FARM);
const tasksCol = () => collection(db, "farms", FARM, "tasks");
const animalsCol = () => collection(db, "farms", FARM, "animals");
const featuresCol = () => collection(db, "farms", FARM, "features");
const notesDoc = () => doc(db, "farms", FARM, "notes", "main");

// ---------- Tasks ----------
let tasks = [];
window.createTask = async () => {
if (!FARM) return alert("Bitte zuerst Betriebscode laden.");
const title = $("tTitle").value.trim();
if (!title) return alert("Titel fehlt.");
const payload = {
title,
date: $("tDate").value || "",
worker: $("tWorker").value.trim(),
place: $("tPlace").value.trim(),
prio: $("tPrio").value,
info: $("tInfo").value.trim(),
done: false,
createdAt: serverTimestamp()
};
await addDoc(tasksCol(), payload);
$("tTitle").value = ""; $("tInfo").value = "";
};

async function toggleTask(id, current){
await updateDoc(doc(db, "farms", FARM, "tasks", id), { done: !current });
}
async function removeTask(id){
await deleteDoc(doc(db, "farms", FARM, "tasks", id));
}
function renderTasks(){
const wrap = $("taskList");
wrap.innerHTML = "";
for (const t of tasks){
const div = document.createElement("div");
div.className = "task" + (t.done ? " done" : "");
div.innerHTML = `
         <b>${escapeHtml(t.title)}</b>
         <div class="meta">ğŸ“… ${escapeHtml(t.date || "â€”")} Â· ğŸ‘¤ ${escapeHtml(t.worker || "â€”")} Â· ğŸ“ ${escapeHtml(t.place || "â€”")} Â· â­ ${escapeHtml(t.prio)}</div>
         <div class="meta">â„¹ï¸ ${escapeHtml(t.info || "")}</div>
         <div style="margin-top:8px;">
           <button class="ok" data-id="${t.id}">${t.done ? "Wieder offen" : "Erledigt"}</button>
           <button class="del" data-del="${t.id}">LÃ¶schen</button>
         </div>
       `;
wrap.appendChild(div);
}
wrap.querySelectorAll("button.ok").forEach(b=>{
b.onclick = ()=> {
const id = b.getAttribute("data-id");
const t = tasks.find(x=>x.id===id);
toggleTask(id, t?.done);
};
});
wrap.querySelectorAll("button.del").forEach(b=>{
b.onclick = ()=> removeTask(b.getAttribute("data-del"));
});

// Stats
const done = tasks.filter(t=>t.done).length;
$("statTasks").innerHTML = `Gesamt: <b>${tasks.length}</b><br>Erledigt: <b>${done}</b><br>Offen: <b>${tasks.length - done}</b>`;
refreshCalendar();
}

// ---------- Notes ----------
window.saveNotes = async () => {
if (!FARM) return alert("Bitte zuerst Betriebscode laden.");
await setDoc(notesDoc(), { text: $("notesArea").value, updatedAt: serverTimestamp() }, { merge: true });
alert("Notizen gespeichert.");
};

// ---------- Animals ----------
let animals = [];
window.addAnimal = async () => {
if (!FARM) return alert("Bitte zuerst Betriebscode laden.");
const type = $("aType").value.trim();
if (!type) return alert("Tierart fehlt.");
await addDoc(animalsCol(), { type, tasks: $("aTasks").value.trim(), createdAt: serverTimestamp() });
$("aType").value = ""; $("aTasks").value = "";
};
async function removeAnimal(id){
await deleteDoc(doc(db, "farms", FARM, "animals", id));
}
function renderAnimals(){
const wrap = $("animalList");
wrap.innerHTML = "";
for (const a of animals){
const div = document.createElement("div");
div.className = "list-item";
div.innerHTML = `
         <div>
           <b>${escapeHtml(a.type)}</b><div class="small">${escapeHtml(a.tasks || "")}</div>
         </div>
         <button data-del="${a.id}">LÃ¶schen</button>
       `;
wrap.appendChild(div);
}
wrap.querySelectorAll("button[data-del]").forEach(b=>{
b.onclick = ()=> removeAnimal(b.getAttribute("data-del"));
});

$("statAnimals").innerHTML = `Tiergruppen: <b>${animals.length}</b>`;
}

// ---------- Map (Switzerland + satellite + draw + delete) ----------
const map = L.map("map", { preferCanvas:true }).setView([46.8, 8.3], 8); // Schweiz
window.map = map;

// Satellite-like layer (Esri World Imagery)
const esriSat = L.tileLayer(
"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
{ maxZoom: 19, attribution: "Tiles Â© Esri" }
);

// Optional overlay labels
const labels = L.tileLayer(
"https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
{ maxZoom: 19, attribution: "Labels Â© Esri" }
);

esriSat.addTo(map);
labels.addTo(map);

const drawn = new L.FeatureGroup();
map.addLayer(drawn);

const drawControl = new L.Control.Draw({
edit: { featureGroup: drawn, remove: true },
draw: {
polyline: false,
rectangle: false,
circle: false,
circlemarker: false
}
});
map.addControl(drawControl);

let features = []; // firestore features
function renderFeatureList(){
const wrap = $("featureList");
wrap.innerHTML = "";
for (const f of features){
const div = document.createElement("div");
div.className = "list-item";
div.innerHTML = `
         <div>
           <b>${escapeHtml(f.name || f.kind)}</b>
           <div class="small">${escapeHtml(f.kind)} Â· id: ${escapeHtml(f.id)}</div>
         </div>
         <button data-del="${f.id}">LÃ¶schen</button>
       `;
wrap.appendChild(div);
}
wrap.querySelectorAll("button[data-del]").forEach(b=>{
b.onclick = ()=> deleteDoc(doc(db, "farms", FARM, "features", b.getAttribute("data-del")));
});

$("statMap").innerHTML = `Objekte: <b>${features.length}</b>`;
}

function clearDrawn(){
drawn.clearLayers();
}
function addGeoJsonToMap(featureDoc){
const gj = featureDoc.geojson;
const layer = L.geoJSON(gj);
layer.eachLayer(l=>{
l.options._fid = featureDoc.id;
l.bindPopup(`<b>${escapeHtml(featureDoc.name || "")}</b><br>${escapeHtml(featureDoc.kind)}`);
drawn.addLayer(l);
});
}

map.on(L.Draw.Event.CREATED, async (e) => {
if (!FARM) return alert("Bitte zuerst Betriebscode laden.");
const layer = e.layer;

let kind = "marker";
if (e.layerType === "polygon") kind = "flaeche";
if (e.layerType === "marker") kind = "marker";

const name = prompt(kind === "flaeche" ? "Name der FlÃ¤che (z.B. Feld 1):" : "Name der Markierung (z.B. Stall):") || "";
const geojson = layer.toGeoJSON();

await addDoc(featuresCol(), {
kind,
name: name.trim(),
geojson,
createdAt: serverTimestamp()
});
});

// When edited in map -> update Firestore
map.on(L.Draw.Event.EDITED, async (e) => {
if (!FARM) return;
const layers = e.layers;
const updates = [];
layers.eachLayer((l) => {
const fid = l.options._fid;
if (!fid) return;
updates.push(updateDoc(doc(db, "farms", FARM, "features", fid), { geojson: l.toGeoJSON() }));
});
await Promise.all(updates);
});

// When deleted in map -> delete in Firestore
map.on(L.Draw.Event.DELETED, async (e) => {
if (!FARM) return;
const layers = e.layers;
const dels = [];
layers.eachLayer((l) => {
const fid = l.options._fid;
if (fid) dels.push(deleteDoc(doc(db, "farms", FARM, "features", fid)));
});
await Promise.all(dels);
});

// ---------- Calendar ----------
let calendar;
function initCalendar(){
const calEl = document.getElementById("cal");
calendar = new FullCalendar.Calendar(calEl, {
initialView: "dayGridMonth",
height: "auto",
headerToolbar: {
left: "prev,next today",
center: "title",
right: "dayGridMonth,timeGridWeek,timeGridDay"
},
eventClick: (info) => {
const t = tasks.find(x=>x.id === info.event.id);
if (!t) return;
alert(
`Titel: ${t.title}\nDatum: ${t.date || "â€”"}\nPerson: ${t.worker || "â€”"}\nOrt: ${t.place || "â€”"}\nPrioritÃ¤t: ${t.prio}\n\nInfos:\n${t.info || ""}`
);
}
});
calendar.render();
}
function refreshCalendar(){
if (!calendar) return;
calendar.removeAllEvents();
for (const t of tasks){
if (!t.date) continue;
calendar.addEvent({
id: t.id,
title: t.title + (t.worker ? " ("+t.worker+")" : ""),
start: t.date,
allDay: true
});
}
}

// ---------- Live listeners ----------
let unsubscribers = [];
function stopListeners(){
unsubscribers.forEach(u=>u());
unsubscribers = [];
}

function startListeners(){
stopListeners();
if (!FARM) return;

// Tasks
unsubscribers.push(onSnapshot(query(tasksCol(), orderBy("createdAt","desc")), (snap)=>{
tasks = snap.docs.map(d=>({ id:d.id, ...d.data() }));
renderTasks();
}));

// Animals
unsubscribers.push(onSnapshot(query(animalsCol(), orderBy("createdAt","desc")), (snap)=>{
animals = snap.docs.map(d=>({ id:d.id, ...d.data() }));
renderAnimals();
}));

// Notes
unsubscribers.push(onSnapshot(notesDoc(), (snap)=>{
const data = snap.data();
$("notesArea").value = data?.text || "";
}));

// Features (Map)
unsubscribers.push(onSnapshot(query(featuresCol(), orderBy("createdAt","desc")), (snap)=>{
features = snap.docs.map(d=>({ id:d.id, ...d.data() }));
clearDrawn();
for (const f of features) addGeoJsonToMap(f);
renderFeatureList();
}));
}

// ---------- Helpers ----------
function escapeHtml(str){
return (str ?? "").toString()
.replaceAll("&","&amp;")
.replaceAll("<","&lt;")
.replaceAll(">","&gt;")
.replaceAll('"',"&quot;")
.replaceAll("'","&#039;");
}

// ---------- Boot ----------
initCalendar();
const initialFarm = getFarmFromUrlOrStorage();
if (initialFarm){
$("farmId").value = initialFarm;
FARM = initialFarm;
startListeners();
} else {
// Default view
showView("dashboard");
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgrarPlanPro</title>
<style>
body{font-family:Arial;margin:0;background:#f4f6f9;}
header{background:#2e7d32;color:white;padding:15px;font-size:20px;}
.container{padding:20px;}
input,select,button{padding:8px;margin:5px 0;}
.task{background:white;padding:10px;margin:8px 0;border-radius:6px;}
</style>
</head>
<body>

<header>AgrarPlanPro</header>

<div class="container">

<h3>Betriebscode</h3>
<input id="farmInput" placeholder="z.B. HOF-01">
<button onclick="loadFarm()">Laden</button>

<hr>

<h3>Neuer Auftrag</h3>
<input id="title" placeholder="Titel">
<input id="date" type="date">
<select id="prio">
  <option value="normal">Normal</option>
  <option value="hoch">Hoch</option>
</select>
<button onclick="addTask()">Speichern</button>

<hr>

<h3>Aufträge</h3>
<div id="tasks"></div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  initializeFirestore,
  collection,
  addDoc,
  onSnapshot,
  query,
  orderBy,
  serverTimestamp,
  deleteDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA7FgCpiflkQpnYcSuTh1q2aXpTfZXQ5vo",
  authDomain: "agrarplanpro.firebaseapp.com",
  projectId: "agrarplanpro",
  storageBucket: "agrarplanpro.firebasestorage.app",
  messagingSenderId: "793787909192",
  appId: "1:793787909192:web:fac554aae83ba8431b847d"
};

const app = initializeApp(firebaseConfig);

const db = initializeFirestore(app, {
  experimentalForceLongPolling: true,
  useFetchStreams: false
});

let FARM = null;
let unsubscribe = null;

function getFarmFromUrl(){
  const params = new URLSearchParams(window.location.search);
  return params.get("farm");
}

window.loadFarm = function(){
  const input = document.getElementById("farmInput").value;
  if(!input){alert("Betriebscode eingeben!");return;}
  FARM = input;
  startListener();
}

function startListener(){
  if(unsubscribe) unsubscribe();

  const q = query(
    collection(db,"farms",FARM,"tasks"),
    orderBy("createdAt","desc")
  );

  unsubscribe = onSnapshot(q,(snapshot)=>{
    const container = document.getElementById("tasks");
    container.innerHTML = "";
    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      const div = document.createElement("div");
      div.className="task";
      div.innerHTML = `
        <b>${data.title}</b><br>
        Datum: ${data.date}<br>
        Priorität: ${data.prio}<br>
        <button onclick="deleteTask('${docSnap.id}')">Löschen</button>
      `;
      container.appendChild(div);
    });
  });
}

window.addTask = async function(){
  if(!FARM){alert("Zuerst Betrieb laden!");return;}

  const title=document.getElementById("title").value;
  const date=document.getElementById("date").value;
  const prio=document.getElementById("prio").value;

  if(!title){alert("Titel fehlt");return;}

  await addDoc(collection(db,"farms",FARM,"tasks"),{
    title,
    date,
    prio,
    done:false,
    createdAt: serverTimestamp()
  });

  document.getElementById("title").value="";
}

window.deleteTask = async function(id){
  await deleteDoc(doc(db,"farms",FARM,"tasks",id));
}

const initialFarm = getFarmFromUrl();
if(initialFarm){
  document.getElementById("farmInput").value=initialFarm;
  FARM=initialFarm;
  startListener();
}

</script>

</body>
</html>

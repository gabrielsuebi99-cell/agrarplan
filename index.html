<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Firebase Test</title>
  <style>
    body{font-family:Arial; padding:20px;}
    .ok{color:green; font-weight:bold;}
    .bad{color:red; font-weight:bold;}
    pre{background:#f4f4f4; padding:12px; border-radius:8px; overflow:auto;}
  </style>
</head>
<body>
  <h1>Firebase / Firestore Verbindungstest</h1>
  <p>Status: <span id="status">Teste…</span></p>
  <p>Projekt: <span id="pid">–</span></p>
  <p>Letzte Aktion: <span id="action">–</span></p>
  <pre id="log"></pre>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      initializeFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const logEl = document.getElementById("log");
    const statusEl = document.getElementById("status");
    const pidEl = document.getElementById("pid");
    const actionEl = document.getElementById("action");

    function log(msg){
      logEl.textContent += msg + "\n";
    }

    // DEINE CONFIG (wie gehabt)
    const firebaseConfig = {
      apiKey: "AIzaSyA7FgCpiflkQpnYcSuTh1q2aXpTfZXQ5vo",
      authDomain: "agrarplanpro.firebaseapp.com",
      projectId: "agrarplanpro",
      storageBucket: "agrarplanpro.firebasestorage.app",
      messagingSenderId: "793787909192",
      appId: "1:793787909192:web:fac554aae83ba8431b847d"
    };

    pidEl.textContent = firebaseConfig.projectId;

    try{
      actionEl.textContent = "Firebase initialisieren…";
      const app = initializeApp(firebaseConfig);

      // Long Polling = robust gegen Schulnetze/Filter
      actionEl.textContent = "Firestore initialisieren…";
      const db = initializeFirestore(app, {
        experimentalForceLongPolling: true,
        useFetchStreams: false
      });

      // Live-Listener auf debug-Collection
      actionEl.textContent = "Listener starten…";
      const q = query(collection(db, "debug"), orderBy("createdAt","desc"));
      onSnapshot(q, (snap)=>{
        statusEl.textContent = "VERBUNDEN ✅ (Live-Daten kommen an)";
        statusEl.className = "ok";
        log("Snapshot: " + snap.size + " Dokument(e) in debug");
      }, (err)=>{
        statusEl.textContent = "NICHT VERBUNDEN ❌ (Listener Fehler)";
        statusEl.className = "bad";
        log("onSnapshot ERROR: " + err.message);
      });

      // Test-Schreiben
      actionEl.textContent = "Test-Dokument schreiben…";
      await addDoc(collection(db, "debug"), {
        from: "github-pages-test",
        createdAt: serverTimestamp(),
        t: new Date().toISOString()
      });

      actionEl.textContent = "Schreiben OK. Warte auf Live-Update…";
      log("Write OK: Test-Dokument gesendet.");

    } catch(e){
      statusEl.textContent = "NICHT VERBUNDEN ❌ (Init Fehler)";
      statusEl.className = "bad";
      log("INIT ERROR: " + (e?.message || e));
      actionEl.textContent = "Fehler beim Start.";
    }
  </script>
</body>
</html>

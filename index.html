<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AgrarPlan Pro</title>

  <!-- Leaflet + Draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">

  <!-- FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">

  <style>
    :root{
      --bg:#f4f6f5; --card:#fff; --side:#163526; --side2:#24533b; --txt:#0d1b12;
      --muted: rgba(0,0,0,.65);
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: Arial, system-ui; background:var(--bg); color:var(--txt); height:100vh; display:flex; }
    .sidebar{ width:260px; background:var(--side); color:#fff; padding:16px; }
    .sidebar h1{ font-size:18px; margin:0 0 8px; }
    .sidebar small{ opacity:.85; display:block; margin-bottom:10px; }
    .navbtn{
      width:100%; padding:10px 12px; border:0; border-radius:12px;
      background:var(--side2); color:#fff; cursor:pointer; margin-top:8px; text-align:left;
    }
    .navbtn:hover{ filter:brightness(1.08); }
    .content{ flex:1; padding:18px; overflow:auto; }
    .topbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    .topbar input{ flex:1; min-width:240px; }
    section{ background:var(--card); border-radius:14px; padding:14px; box-shadow:0 2px 10px rgba(0,0,0,.05); }
    section.hide{ display:none; }
    h2{ margin:0 0 10px; font-size:18px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
    .card{ background:#fff; border-radius:14px; padding:14px; box-shadow:0 2px 10px rgba(0,0,0,.05); }
    input, select, textarea{
      width:100%; padding:10px; border-radius:12px; border:1px solid #d8e0db; margin:6px 0;
    }
    textarea{ min-height:90px; resize:vertical; }
    .task{ border-left:6px solid #2c7a4b; padding:10px; border-radius:12px; background:#fbfcfb; margin-top:10px; }
    .task.done{ opacity:.65; text-decoration:line-through; }
    .meta{ font-size:13px; color:var(--muted); margin-top:6px; white-space:pre-wrap; }
    .task button{ padding:8px 10px; border:0; border-radius:10px; cursor:pointer; margin-right:8px; }
    .ok{ background:#dff3e7; }
    .del{ background:#ffe2e2; }
    #map{ height:540px; border-radius:14px; }
    .list{ margin-top:10px; }
    .list-item{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px; border-radius:12px; background:#f7faf8; margin-top:8px;
    }
    .list-item .small{ font-size:12px; color:var(--muted); }
    .list-item button{ padding:8px 10px; border:0; border-radius:10px; cursor:pointer; background:#ffe2e2; }
    #cal{ background:#fff; border-radius:14px; padding:10px; }
  </style>
</head>

<body>
  <div class="sidebar">
    <h1>ğŸŒ¾ AgrarPlan Pro</h1>
    <small>Live-Sync â€¢ Schweiz â€¢ Satellit â€¢ FlÃ¤chen â€¢ Kalender</small>

    <button class="navbtn" onclick="showView('dashboard')">ğŸ“Š Dashboard</button>
    <button class="navbtn" onclick="showView('tasks')">ğŸ“‹ AuftrÃ¤ge</button>
    <button class="navbtn" onclick="showView('calendar')">ğŸ“… Kalender</button>
    <button class="navbtn" onclick="showView('map')">ğŸ›° Karte</button>
    <button class="navbtn" onclick="showView('animals')">ğŸ„ Tiere</button>
    <button class="navbtn" onclick="showView('notes')">ğŸ“ Notizen</button>
  </div>

  <div class="content">
    <div class="topbar">
      <input id="farmId" placeholder="Betriebscode (z.B. HOF-01)" />
      <button class="navbtn" style="width:auto" onclick="applyFarm()">âœ… Laden</button>
      <button class="navbtn" style="width:auto" onclick="copyShareLink()">ğŸ”— Link teilen</button>
    </div>

    <section id="view-dashboard">
      <h2>ğŸ“Š Dashboard</h2>
      <div class="row">
        <div class="card" style="flex:1; min-width:240px;">
          <h2>AuftrÃ¤ge</h2>
          <div id="statTasks">â€“</div>
        </div>
        <div class="card" style="flex:1; min-width:240px;">
          <h2>Karte</h2>
          <div id="statMap">â€“</div>
        </div>
        <div class="card" style="flex:1; min-width:240px;">
          <h2>Tiere</h2>
          <div id="statAnimals">â€“</div>
        </div>
      </div>
    </section>

    <section id="view-tasks" class="hide">
      <h2>ğŸ“‹ AuftrÃ¤ge</h2>
      <div class="row">
        <div class="card" style="flex:1; min-width:260px;">
          <h2>â• Neuer Auftrag</h2>
          <input id="tTitle" placeholder="Titel (z.B. Stall ausmisten)" />
          <input type="date" id="tDate" />
          <input id="tWorker" placeholder="Person/Team (frei eingeben)" />
          <input id="tPlace" placeholder="Ort (z.B. Stall / Feld 3 / Lager)" />
          <select id="tPrio">
            <option value="normal">PrioritÃ¤t: Normal</option>
            <option value="hoch">PrioritÃ¤t: Hoch</option>
            <option value="niedrig">PrioritÃ¤t: Niedrig</option>
          </select>
          <textarea id="tInfo" placeholder="Weitere Infosâ€¦"></textarea>
          <button class="navbtn" onclick="createTask()">Speichern</button>
        </div>

        <div class="card" style="flex:2; min-width:300px;">
          <h2>ğŸ“Œ Liste</h2>
          <div id="taskList"></div>
        </div>
      </div>
    </section>

    <section id="view-calendar" class="hide">
      <h2>ğŸ“… Kalender</h2>
      <div id="cal"></div>
    </section>

    <section id="view-map" class="hide">
      <h2>ğŸ›° Karte Schweiz (Satellit + FlÃ¤chen)</h2>
      <div class="row">
        <div class="card" style="flex:2; min-width:320px;">
          <div id="map"></div>
          <div class="meta">
            Zeichnen: Marker/FlÃ¤che Ã¼ber Tools links oben. LÃ¶schen: Papierkorb-Tool oder Liste rechts.
          </div>
        </div>
        <div class="card" style="flex:1; min-width:260px;">
          <h2>ğŸ§¾ Objekte</h2>
          <div id="featureList" class="list"></div>
        </div>
      </div>
    </section>

    <section id="view-animals" class="hide">
      <h2>ğŸ„ Tiere & Aufgaben</h2>
      <div class="row">
        <div class="card" style="flex:1; min-width:260px;">
          <h2>â• Tiergruppe</h2>
          <input id="aType" placeholder="Tierart (z.B. KÃ¼he, HÃ¼hner)" />
          <textarea id="aTasks" placeholder="Was muss man machen?"></textarea>
          <button class="navbtn" onclick="addAnimal()">Speichern</button>
        </div>
        <div class="card" style="flex:2; min-width:300px;">
          <h2>ğŸ“Œ Liste</h2>
          <div id="animalList"></div>
        </div>
      </div>
    </section>

    <section id="view-notes" class="hide">
      <h2>ğŸ“ Notizen</h2>
      <textarea id="notesArea" placeholder="Allgemeine Notizenâ€¦"></textarea>
      <button class="navbtn" onclick="saveNotes()">Speichern</button>
      <div class="meta">Notizen werden live synchronisiert.</div>
    </section>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      initializeFirestore, collection, doc, setDoc, addDoc, deleteDoc, updateDoc,
      onSnapshot, query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const $ = (id) => document.getElementById(id);

    const firebaseConfig = {
      apiKey: "AIzaSyA7FgCpiflkQpnYcSuTh1q2aXpTfZXQ5vo",
      authDomain: "agrarplanpro.firebaseapp.com",
      projectId: "agrarplanpro",
      storageBucket: "agrarplanpro.firebasestorage.app",
      messagingSenderId: "793787909192",
      appId: "1:793787909192:web:fac554aae83ba8431b847d"
    };

    const app = initializeApp(firebaseConfig);

    // âœ… robust (wie dein funktionierender Test)
    const db = initializeFirestore(app, {
      experimentalForceLongPolling: true,
      useFetchStreams: false
    });

    // Navigation
    window.showView = (name) => {
      for (const s of ["dashboard","tasks","calendar","map","animals","notes"]) {
        $("view-"+s).classList.toggle("hide", s !== name);
      }
      if (name === "map") setTimeout(() => map.invalidateSize(), 150);
    };

    // Farm
    let FARM = "";
    function getFarmFromUrlOrStorage(){
      const url = new URL(window.location.href);
      return (url.searchParams.get("farm") || localStorage.getItem("farmId") || "").trim();
    }
    function setFarmToUrl(farm){
      const url = new URL(window.location.href);
      url.searchParams.set("farm", farm);
      history.replaceState({}, "", url.toString());
    }

    window.applyFarm = () => {
      const f = ($("farmId").value || "").trim();
      if (!f) return alert("Bitte Betriebscode eingeben.");
      FARM = f;
      localStorage.setItem("farmId", FARM);
      setFarmToUrl(FARM);
      startListeners();
      alert("Betriebscode geladen: " + FARM);
    };

    window.copyShareLink = async () => {
      if (!FARM) return alert("Erst Betriebscode laden.");
      const url = new URL(window.location.href);
      url.searchParams.set("farm", FARM);
      await navigator.clipboard.writeText(url.toString());
      alert("Link kopiert.");
    };

    // Paths
    const tasksCol = () => collection(db, "farms", FARM, "tasks");
    const animalsCol = () => collection(db, "farms", FARM, "animals");
    const featuresCol = () => collection(db, "farms", FARM, "features");
    const notesDoc = () => doc(db, "farms", FARM, "notes", "main");

    // Tasks
    let tasks = [];
    window.createTask = async () => {
      if (!FARM) return alert("Bitte zuerst Betriebscode laden.");
      const title = ($("tTitle").value || "").trim();
      if (!title) return alert("Titel fehlt.");

      await addDoc(tasksCol(), {
        title,
        date: $("tDate").value || "",
        worker: ($("tWorker").value || "").trim(),
        place: ($("tPlace").value || "").trim(),
        prio: $("tPrio").value,
        info: ($("tInfo").value || "").trim(),
        done: false,
        createdAt: serverTimestamp()
      });

      $("tTitle").value = "";
      $("tInfo").value = "";
    };

    async function toggleTask(id, current){
      await updateDoc(doc(db, "farms", FARM, "tasks", id), { done: !current });
    }
    async function removeTask(id){
      await deleteDoc(doc(db, "farms", FARM, "tasks", id));
    }

    function escapeHtml(str){
      return (str ?? "").toString()
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function renderTasks(){
      const wrap = $("taskList");
      wrap.innerHTML = "";
      for (const t of tasks){
        const div = document.createElement("div");
        div.className = "task" + (t.done ? " done" : "");
        div.innerHTML = `
          <b>${escapeHtml(t.title)}</b>
          <div class="meta">ğŸ“… ${escapeHtml(t.date || "â€”")} Â· ğŸ‘¤ ${escapeHtml(t.worker || "â€”")} Â· ğŸ“ ${escapeHtml(t.place || "â€”")} Â· â­ ${escapeHtml(t.prio)}</div>
          <div class="meta">${escapeHtml(t.info || "")}</div>
          <div style="margin-top:8px;">
            <button class="ok" data-id="${t.id}">${t.done ? "Wieder offen" : "Erledigt"}</button>
            <button class="del" data-del="${t.id}">LÃ¶schen</button>
          </div>
        `;
        wrap.appendChild(div);
      }
      wrap.querySelectorAll("button.ok").forEach(b=>{
        b.onclick = ()=> {
          const id = b.getAttribute("data-id");
          const t = tasks.find(x=>x.id===id);
          if (t) toggleTask(id, t.done);
        };
      });
      wrap.querySelectorAll("button.del").forEach(b=>{
        b.onclick = ()=> removeTask(b.getAttribute("data-del"));
      });

      const done = tasks.filter(t=>t.done).length;
      $("statTasks").innerHTML = `Gesamt: <b>${tasks.length}</b><br>Erledigt: <b>${done}</b><br>Offen: <b>${tasks.length - done}</b>`;
      refreshCalendar();
    }

    // Notes
    window.saveNotes = async () => {
      if (!FARM) return alert("Bitte zuerst Betriebscode laden.");
      await setDoc(notesDoc(), { text: $("notesArea").value || "", updatedAt: serverTimestamp() }, { merge: true });
      alert("Notizen gespeichert.");
    };

    // Animals
    let animals = [];
    window.addAnimal = async () => {
      if (!FARM) return alert("Bitte zuerst Betriebscode laden.");
      const type = ($("aType").value || "").trim();
      if (!type) return alert("Tierart fehlt.");
      await addDoc(animalsCol(), { type, tasks: ($("aTasks").value || "").trim(), createdAt: serverTimestamp() });
      $("aType").value = ""; $("aTasks").value = "";
    };
    async function removeAnimal(id){ await deleteDoc(doc(db, "farms", FARM, "animals", id)); }
    function renderAnimals(){
      const wrap = $("animalList");
      wrap.innerHTML = "";
      for (const a of animals){
        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `
          <div>
            <b>${escapeHtml(a.type)}</b>
            <div class="small">${escapeHtml(a.tasks || "")}</div>
          </div>
          <button data-del="${a.id}">LÃ¶schen</button>
        `;
        wrap.appendChild(div);
      }
      wrap.querySelectorAll("button[data-del]").forEach(b=>{
        b.onclick = ()=> removeAnimal(b.getAttribute("data-del"));
      });
      $("statAnimals").innerHTML = `Tiergruppen: <b>${animals.length}</b>`;
    }

    // Map Switzerland
    const map = L.map("map").setView([46.8, 8.3], 8);

    L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 19, attribution: "Tiles Â© Esri" }
    ).addTo(map);

    const drawn = new L.FeatureGroup(); map.addLayer(drawn);

    map.addControl(new L.Control.Draw({
      edit: { featureGroup: drawn, remove: true },
      draw: { polyline:false, rectangle:false, circle:false, circlemarker:false }
    }));

    let features = [];
    function clearDrawn(){ drawn.clearLayers(); }

    function addFeatureToMap(featureDoc){
      const gj = JSON.parse(featureDoc.geojsonStr);
      const layerGroup = L.geoJSON(gj);
      layerGroup.eachLayer(l => {
        l.options._fid = featureDoc.id;
        l.bindPopup(`<b>${escapeHtml(featureDoc.name || "")}</b><br>${escapeHtml(featureDoc.kind)}`);
        drawn.addLayer(l);
      });
    }

    function renderFeatureList(){
      const wrap = $("featureList");
      wrap.innerHTML = "";
      for (const f of features){
        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `
          <div>
            <b>${escapeHtml(f.name || f.kind)}</b>
            <div class="small">${escapeHtml(f.kind)}</div>
          </div>
          <button data-del="${f.id}">LÃ¶schen</button>
        `;
        wrap.appendChild(div);
      }
      wrap.querySelectorAll("button[data-del]").forEach(b=>{
        b.onclick = ()=> deleteDoc(doc(db, "farms", FARM, "features", b.getAttribute("data-del")));
      });
      $("statMap").innerHTML = `Objekte: <b>${features.length}</b>`;
    }

    map.on(L.Draw.Event.CREATED, async (e) => {
      if (!FARM) return alert("Bitte zuerst Betriebscode laden.");
      const layer = e.layer;
      const kind = (e.layerType === "polygon") ? "flaeche" : "marker";
      const name = prompt(kind === "flaeche" ? "Name der FlÃ¤che:" : "Name der Markierung:") || "";
      const geojsonStr = JSON.stringify(layer.toGeoJSON()); // âœ… fixes nested arrays
      await addDoc(featuresCol(), { kind, name: name.trim(), geojsonStr, createdAt: serverTimestamp() });
    });

    map.on(L.Draw.Event.EDITED, async (e) => {
      if (!FARM) return;
      const updates = [];
      e.layers.eachLayer(l => {
        const fid = l.options._fid;
        if (!fid) return;
        updates.push(updateDoc(doc(db, "farms", FARM, "features", fid), {
          geojsonStr: JSON.stringify(l.toGeoJSON())
        }));
      });
      await Promise.all(updates);
    });

    map.on(L.Draw.Event.DELETED, async (e) => {
      if (!FARM) return;
      const dels = [];
      e.layers.eachLayer(l => {
        const fid = l.options._fid;
        if (fid) dels.push(deleteDoc(doc(db, "farms", FARM, "features", fid)));
      });
      await Promise.all(dels);
    });

    // Calendar
    let calendar;
    function initCalendar(){
      calendar = new FullCalendar.Calendar(document.getElementById("cal"), {
        initialView: "dayGridMonth",
        height: "auto",
        headerToolbar: { left:"prev,next today", center:"title", right:"dayGridMonth,timeGridWeek,timeGridDay" },
        eventClick: (info) => {
          const t = tasks.find(x => x.id === info.event.id);
          if (!t) return;
          alert(`Titel: ${t.title}\nDatum: ${t.date || "â€”"}\nPerson: ${t.worker || "â€”"}\nOrt: ${t.place || "â€”"}\nPrioritÃ¤t: ${t.prio}\n\nInfos:\n${t.info || ""}`);
        }
      });
      calendar.render();
    }
    function refreshCalendar(){
      if (!calendar) return;
      calendar.removeAllEvents();
      for (const t of tasks){
        if (!t.date) continue;
        calendar.addEvent({ id:t.id, title: t.title, start:t.date, allDay:true });
      }
    }
    initCalendar();

    // Live listeners
    let unsubscribers = [];
    function stopListeners(){ unsubscribers.forEach(u=>u()); unsubscribers=[]; }

    function startListeners(){
      stopListeners();
      if (!FARM) return;

      unsubscribers.push(onSnapshot(query(tasksCol(), orderBy("createdAt","desc")), (snap)=>{
        tasks = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        renderTasks();
      }));

      unsubscribers.push(onSnapshot(query(animalsCol(), orderBy("createdAt","desc")), (snap)=>{
        animals = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        renderAnimals();
      }));

      unsubscribers.push(onSnapshot(notesDoc(), (snap)=>{
        $("notesArea").value = snap.data()?.text || "";
      }));

      unsubscribers.push(onSnapshot(query(featuresCol(), orderBy("createdAt","desc")), (snap)=>{
        features = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        clearDrawn();
        for (const f of features) if (f.geojsonStr) addFeatureToMap(f);
        renderFeatureList();
      }));
    }

    // Boot
    const initialFarm = getFarmFromUrlOrStorage();
    if (initialFarm){
      $("farmId").value = initialFarm;
      FARM = initialFarm;
      startListeners();
    } else {
      showView("dashboard");
    }
  </script>
</body>
</html>
